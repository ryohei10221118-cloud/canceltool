<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cancel Tool - Betting Data Extraction</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a2e;
      color: #e0e0e0;
      padding: 20px;
      min-height: 100vh;
    }
    h1 {
      text-align: center;
      color: #00d4ff;
      margin-bottom: 20px;
      font-size: 1.5rem;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    /* Input Section */
    .input-section {
      background: #16213e;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid #0f3460;
    }
    .input-section label {
      display: block;
      margin-bottom: 8px;
      color: #00d4ff;
      font-weight: 600;
    }
    textarea {
      width: 100%;
      height: 200px;
      background: #0a0a1a;
      color: #e0e0e0;
      border: 1px solid #0f3460;
      border-radius: 6px;
      padding: 12px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      resize: vertical;
    }
    textarea:focus { outline: none; border-color: #00d4ff; }

    .btn-row {
      display: flex;
      gap: 10px;
      margin-top: 12px;
    }
    button {
      padding: 10px 24px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    button:active { transform: scale(0.97); }
    .btn-extract {
      background: #00d4ff;
      color: #1a1a2e;
    }
    .btn-extract:hover { background: #00b8d9; }
    .btn-copy {
      background: #e94560;
      color: #fff;
    }
    .btn-copy:hover { background: #c73e54; }
    .btn-now {
      background: #2e7d32;
      color: #fff;
      padding: 6px 14px;
      font-size: 12px;
      border-radius: 4px;
    }
    .btn-now:hover { background: #388e3c; }
    .btn-clear {
      background: #444;
      color: #e0e0e0;
    }
    .btn-clear:hover { background: #555; }

    /* Result Section */
    .result-section {
      background: #16213e;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid #0f3460;
      display: none;
    }
    .result-section.active { display: block; }
    .section-title {
      color: #00d4ff;
      font-weight: 600;
      margin-bottom: 12px;
      font-size: 1.1rem;
    }

    /* Data Table */
    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 16px;
      font-size: 13px;
    }
    .data-table th {
      background: #0f3460;
      color: #00d4ff;
      padding: 10px 8px;
      text-align: left;
      white-space: nowrap;
    }
    .data-table td {
      padding: 10px 8px;
      border-bottom: 1px solid #1a2a4a;
    }
    .data-table tr:hover td { background: #1a2a4a; }
    .data-table .overflow-cell {
      max-width: 250px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .tag-prematch {
      background: #2e7d32;
      color: #fff;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 12px;
    }
    .tag-live {
      background: #e94560;
      color: #fff;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 12px;
    }

    /* Note Section */
    .note-section {
      background: #0a0a1a;
      border: 1px solid #0f3460;
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
    }
    .note-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .note-row:last-child { margin-bottom: 0; }
    .note-row label {
      color: #aaa;
      min-width: 100px;
      font-size: 13px;
    }
    .note-row input[type="text"] {
      background: #16213e;
      color: #e0e0e0;
      border: 1px solid #0f3460;
      border-radius: 4px;
      padding: 6px 10px;
      font-size: 14px;
      flex: 1;
      min-width: 200px;
    }
    .note-row input[type="text"]:focus { outline: none; border-color: #00d4ff; }
    .time-input {
      background: #16213e;
      color: #e0e0e0;
      border: 1px solid #0f3460;
      border-radius: 4px;
      padding: 6px 8px;
      font-size: 16px;
      font-family: 'Courier New', monospace;
      width: 42px;
      text-align: center;
      flex: none;
      min-width: unset;
    }
    .time-input:focus { outline: none; border-color: #00d4ff; }
    .btn-edit {
      background: #0f3460;
      color: #aaa;
      padding: 4px 12px;
      font-size: 12px;
      border-radius: 4px;
    }
    .btn-edit:hover { background: #1a4a80; color: #e0e0e0; }
    .edit-reasons-panel {
      display: none;
      background: #16213e;
      border: 1px solid #0f3460;
      border-radius: 6px;
      padding: 12px;
      margin-top: 8px;
      margin-bottom: 8px;
    }
    .edit-reasons-panel.active { display: block; }
    .edit-reason-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    .edit-reason-row input {
      background: #0a0a1a;
      color: #e0e0e0;
      border: 1px solid #0f3460;
      border-radius: 4px;
      padding: 6px 10px;
      font-size: 13px;
      flex: 1;
    }
    .edit-reason-row input:focus { outline: none; border-color: #00d4ff; }
    select {
      background: #16213e;
      color: #e0e0e0;
      border: 1px solid #0f3460;
      border-radius: 4px;
      padding: 6px 10px;
      font-size: 14px;
      cursor: pointer;
    }
    select:focus { outline: none; border-color: #00d4ff; }

    .done-time {
      color: #4caf50;
      font-weight: 600;
      font-size: 14px;
    }

    /* Preview */
    .preview-box {
      background: #0a0a1a;
      border: 1px dashed #0f3460;
      border-radius: 6px;
      padding: 12px;
      margin-top: 12px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      white-space: pre-wrap;
      word-break: break-all;
      color: #ccc;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: #4caf50;
      color: #fff;
      padding: 12px 28px;
      border-radius: 8px;
      font-weight: 600;
      opacity: 0;
      transition: all 0.3s;
      z-index: 999;
    }
    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    /* Status tags */
    .tag-status {
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }
    .tag-status-0 { background: #0f3460; color: #00d4ff; }
    .tag-status-1 { background: #c62828; color: #fff; }
    .tag-status-2 { background: #2e7d32; color: #fff; }
    .tag-status-3 { background: #757575; color: #fff; }
    .tag-status-4 { background: #e94560; color: #fff; }
    .tag-status-15 { background: #b71c1c; color: #fff; }
    .tag-status-16 { background: #e65100; color: #fff; }
    .tag-status-17 { background: #558b2f; color: #fff; }
    .tag-status-32 { background: #f5a623; color: #1a1a2e; }

    /* Checkbox */
    .data-table input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
      accent-color: #00d4ff;
    }
    .data-table tr.row-checked td {
      background: rgba(0, 212, 255, 0.08);
    }

    /* Skipped info */
    .skipped-info {
      margin-top: 12px;
      padding: 10px;
      background: #1a2a4a;
      border-radius: 6px;
      font-size: 13px;
      color: #aaa;
      display: none;
    }
    .skipped-info strong { color: #f5a623; }

    /* Ticket info bar */
    .ticket-bar {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      margin-bottom: 16px;
      padding: 10px 14px;
      background: #0f3460;
      border-radius: 6px;
      font-size: 13px;
    }
    .ticket-bar span { color: #aaa; }
    .ticket-bar strong { color: #00d4ff; }
  </style>
</head>
<body>

<div class="container">
  <h1>Cancel Tool - Betting Data Extraction</h1>

  <!-- Input -->
  <div class="input-section">
    <label for="jsonInput">Paste JSON Data</label>
    <textarea id="jsonInput" placeholder="Paste the full ticket JSON here..."></textarea>
    <div class="btn-row">
      <button class="btn-extract" onclick="extractData()">Extract</button>
      <button class="btn-clear" onclick="clearAll()">Clear</button>
    </div>
  </div>

  <!-- Result -->
  <div class="result-section" id="resultSection">
    <!-- Ticket Info -->
    <div class="ticket-bar" id="ticketBar"></div>

    <div class="section-title">All Selections</div>
    <div style="overflow-x: auto;">
      <table class="data-table" id="dataTable">
        <thead>
          <tr>
            <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)"></th>
            <th>#</th>
            <th>Status</th>
            <th>SportName</th>
            <th>LeagueName</th>
            <th>Prematch/Live</th>
            <th>StartEventDate (UTC+8)</th>
            <th>EventName</th>
          </tr>
        </thead>
        <tbody id="dataBody"></tbody>
      </table>
    </div>
    <div class="selection-actions" style="margin-top: 8px; display: flex; gap: 10px; font-size: 13px; color: #aaa;">
      <span id="checkedCount">0 selected</span>
    </div>

    <!-- Note Section -->
    <div class="note-section">
      <div class="section-title" style="margin-bottom: 14px;">Note</div>
      <div class="note-row">
        <label>Request Time:</label>
        <input type="text" id="requestHour" class="time-input" maxlength="2" placeholder="HH" oninput="handleTimeInput(this, 'requestMinuteInput'); updateAllPreview();">
        <span style="color:#aaa; font-size:18px; font-weight:bold;">:</span>
        <input type="text" id="requestMinuteInput" class="time-input" maxlength="2" placeholder="MM" oninput="updateAllPreview();">
        <button class="btn-now" onclick="fillNowTime()">Now</button>
        <span style="color:#aaa;">pls cancel</span>
      </div>
      <div class="note-row">
        <label>Reason:</label>
        <select id="reasonSelect" onchange="handleReasonChange()">
          <option value="postponed match, 24 hours rule">postponed match, 24 hours rule</option>
          <option value="no info over 3 hours">no info over 3 hours</option>
          <option value="__custom__">Custom (self-input)</option>
        </select>
        <input type="text" id="customReason" placeholder="Enter custom reason..." style="display:none;">
        <button class="btn-edit" onclick="toggleEditReasons()">Edit</button>
      </div>
      <div class="edit-reasons-panel" id="editReasonsPanel">
        <div class="edit-reason-row">
          <span style="color:#aaa; font-size:12px;">Option 1:</span>
          <input type="text" id="editReason1" value="postponed match, 24 hours rule" oninput="syncReasonOptions()">
        </div>
        <div class="edit-reason-row">
          <span style="color:#aaa; font-size:12px;">Option 2:</span>
          <input type="text" id="editReason2" value="no info over 3 hours" oninput="syncReasonOptions()">
        </div>
        <button class="btn-edit" onclick="toggleEditReasons()" style="margin-top:8px;">Done</button>
      </div>
      <div class="note-row">
        <label>Done Time:</label>
        <span class="done-time" id="doneTimeDisplay">--:--</span>
        <span style="color:#aaa;">done</span>
      </div>
    </div>

    <div class="btn-row" style="margin-top: 16px;">
      <button class="btn-copy" onclick="copyAll()">Copy All</button>
    </div>
    <div class="preview-box" id="allPreview"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  let allRows = [];       // All selections data
  let checkedSet = new Set(); // Indices of checked rows (keyed by EventName+LeagueName for re-extract matching)
  let doneTimeStr = '';

  const STATUS_LABELS = {
    0: 'Opened',
    1: 'Lost',
    2: 'Won',
    3: 'Draw',
    4: 'Canceled',
    15: 'Declined',
    16: 'Half Lost',
    17: 'Half Won',
    32: 'Cashout'
  };

  function getRowKey(sel) {
    // Unique key per selection for preserving checkbox state across re-extract
    return `${sel.EventName || ''}||${sel.LeagueName || ''}||${sel.SportName || ''}`;
  }

  function extractData() {
    const raw = document.getElementById('jsonInput').value.trim();
    if (!raw) {
      showToast('Please paste JSON data first', '#e94560');
      return;
    }

    let data;
    try {
      data = JSON.parse(raw);
    } catch (e) {
      showToast('JSON parse error: ' + e.message, '#e94560');
      return;
    }

    const selections = data.Selections || [];
    if (selections.length === 0) {
      showToast('No selections found', '#f5a623');
      return;
    }

    // Preserve previous checked state (keyed by row key)
    const prevCheckedKeys = new Set();
    allRows.forEach((r, i) => {
      if (checkedSet.has(i)) prevCheckedKeys.add(r.key);
    });

    // Extract done time
    doneTimeStr = extractDoneTime(data);

    // Build ticket info bar
    const ticketIdMatch = raw.match(/"TicketId"\s*:\s*(\d+)/);
    const ticketId = ticketIdMatch ? ticketIdMatch[1] : 'N/A';
    const betType = data.Bets?.[0]?.Name || 'N/A';
    const totalSelections = selections.length;

    document.getElementById('ticketBar').innerHTML =
      `<span>Ticket ID: <strong>${ticketId}</strong></span>` +
      `<span>Type: <strong>${betType}</strong></span>` +
      `<span>Total Selections: <strong>${totalSelections}</strong></span>`;

    // Build table rows for ALL selections
    allRows = [];
    checkedSet = new Set();
    const tbody = document.getElementById('dataBody');
    tbody.innerHTML = '';

    selections.forEach((sel, idx) => {
      const sport = sel.SportName || '';
      const league = sel.LeagueName || '';
      const prematchLive = sel.IsLive ? 'Live' : 'Prematch';
      const startDate = convertToUTC8(sel.StartEventDate);
      const eventName = sel.EventName || '';
      const status = sel.SelectionStatus;
      const key = getRowKey(sel);

      allRows.push({ sport, league, prematchLive, startDate, eventName, status, key });

      // Restore checked state from previous extract
      const shouldCheck = prevCheckedKeys.has(key);
      if (shouldCheck) checkedSet.add(idx);

      const tagClass = sel.IsLive ? 'tag-live' : 'tag-prematch';
      const statusLabel = STATUS_LABELS[status] !== undefined ? STATUS_LABELS[status] : `Status ${status}`;
      const tr = document.createElement('tr');
      if (shouldCheck) tr.classList.add('row-checked');
      tr.innerHTML =
        `<td><input type="checkbox" data-idx="${idx}" onchange="handleRowCheck(this)" ${shouldCheck ? 'checked' : ''}></td>` +
        `<td>${idx + 1}</td>` +
        `<td><span class="tag-status tag-status-${status}">${statusLabel}</span></td>` +
        `<td>${sport}</td>` +
        `<td class="overflow-cell" title="${league}">${league}</td>` +
        `<td><span class="${tagClass}">${prematchLive}</span></td>` +
        `<td>${startDate}</td>` +
        `<td class="overflow-cell" title="${eventName}">${eventName}</td>`;
      tbody.appendChild(tr);
    });

    // Update select-all checkbox state
    updateSelectAllState();
    updateCheckedCount();

    // Set done time display
    document.getElementById('doneTimeDisplay').textContent = doneTimeStr || '--:--';

    // Update preview
    updateAllPreview();

    // Show result section
    document.getElementById('resultSection').classList.add('active');
    showToast(`Extracted ${totalSelections} selection(s)`, '#4caf50');
  }

  function handleRowCheck(cb) {
    const idx = parseInt(cb.dataset.idx);
    const tr = cb.closest('tr');
    if (cb.checked) {
      checkedSet.add(idx);
      tr.classList.add('row-checked');
    } else {
      checkedSet.delete(idx);
      tr.classList.remove('row-checked');
    }
    updateSelectAllState();
    updateCheckedCount();
    updateAllPreview();
  }

  function toggleSelectAll(cb) {
    const checkboxes = document.querySelectorAll('#dataBody input[type="checkbox"]');
    checkboxes.forEach(box => {
      const idx = parseInt(box.dataset.idx);
      const tr = box.closest('tr');
      box.checked = cb.checked;
      if (cb.checked) {
        checkedSet.add(idx);
        tr.classList.add('row-checked');
      } else {
        checkedSet.delete(idx);
        tr.classList.remove('row-checked');
      }
    });
    updateCheckedCount();
    updateAllPreview();
  }

  function updateSelectAllState() {
    const all = document.querySelectorAll('#dataBody input[type="checkbox"]');
    const selectAllCb = document.getElementById('selectAll');
    if (all.length === 0) {
      selectAllCb.checked = false;
      selectAllCb.indeterminate = false;
      return;
    }
    const checkedCount = checkedSet.size;
    if (checkedCount === 0) {
      selectAllCb.checked = false;
      selectAllCb.indeterminate = false;
    } else if (checkedCount === all.length) {
      selectAllCb.checked = true;
      selectAllCb.indeterminate = false;
    } else {
      selectAllCb.checked = false;
      selectAllCb.indeterminate = true;
    }
  }

  function updateCheckedCount() {
    document.getElementById('checkedCount').textContent = `${checkedSet.size} selected`;
  }

  function extractDoneTime(data) {
    if (data.SettlementHistory && data.SettlementHistory.length > 0) {
      const last = data.SettlementHistory[data.SettlementHistory.length - 1];
      if (last.DateUpdated) {
        return formatTimeUTC8(last.DateUpdated);
      }
    }
    if (data.UpdateDate) {
      return formatTimeUTC8(data.UpdateDate);
    }
    return '';
  }

  function convertToUTC8(dateStr) {
    if (!dateStr) return '';
    let d;
    if (dateStr.endsWith('Z')) {
      d = new Date(dateStr);
    } else {
      d = new Date(dateStr + 'Z');
    }
    d = new Date(d.getTime() + 8 * 60 * 60 * 1000);
    return formatDateTime(d);
  }

  function formatDateTime(d) {
    const yyyy = d.getUTCFullYear();
    const mm = String(d.getUTCMonth() + 1).padStart(2, '0');
    const dd = String(d.getUTCDate()).padStart(2, '0');
    const hh = String(d.getUTCHours()).padStart(2, '0');
    const mi = String(d.getUTCMinutes()).padStart(2, '0');
    const ss = String(d.getUTCSeconds()).padStart(2, '0');
    return `${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
  }

  function formatTimeUTC8(dateStr) {
    if (!dateStr) return '';
    let d;
    if (dateStr.endsWith('Z')) {
      d = new Date(dateStr);
    } else {
      d = new Date(dateStr + 'Z');
    }
    d = new Date(d.getTime() + 8 * 60 * 60 * 1000);
    const hh = String(d.getUTCHours()).padStart(2, '0');
    const mi = String(d.getUTCMinutes()).padStart(2, '0');
    return `${hh}:${mi}`;
  }

  function handleTimeInput(el, nextId) {
    el.value = el.value.replace(/\D/g, '');
    if (el.value.length === 2 && nextId) {
      document.getElementById(nextId).focus();
    }
  }

  function fillNowTime() {
    const now = new Date();
    const utc8 = new Date(now.getTime() + 8 * 60 * 60 * 1000);
    document.getElementById('requestHour').value = String(utc8.getUTCHours()).padStart(2, '0');
    document.getElementById('requestMinuteInput').value = String(utc8.getUTCMinutes()).padStart(2, '0');
    updateAllPreview();
  }

  function getRequestTime() {
    const h = document.getElementById('requestHour').value.trim();
    const m = document.getElementById('requestMinuteInput').value.trim();
    if (!h || !m) return '__:__';
    return `${h.padStart(2, '0')}:${m.padStart(2, '0')}`;
  }

  function toggleEditReasons() {
    document.getElementById('editReasonsPanel').classList.toggle('active');
  }

  function syncReasonOptions() {
    const sel = document.getElementById('reasonSelect');
    const v1 = document.getElementById('editReason1').value.trim();
    const v2 = document.getElementById('editReason2').value.trim();
    sel.options[0].value = v1;
    sel.options[0].textContent = v1;
    sel.options[1].value = v2;
    sel.options[1].textContent = v2;
    updateAllPreview();
  }

  function getSelectedReason() {
    const sel = document.getElementById('reasonSelect');
    if (sel.value === '__custom__') {
      return document.getElementById('customReason').value.trim();
    }
    return sel.value;
  }

  function handleReasonChange() {
    const sel = document.getElementById('reasonSelect');
    const customInput = document.getElementById('customReason');
    if (sel.value === '__custom__') {
      customInput.style.display = 'block';
      customInput.focus();
    } else {
      customInput.style.display = 'none';
    }
    updateAllPreview();
  }

  function getCheckedRows() {
    return allRows.filter((_, i) => checkedSet.has(i));
  }

  function buildAllText() {
    const checked = getCheckedRows();
    if (checked.length === 0) return '(No selections checked)';
    const tableLines = checked.map(r =>
      `${r.sport}\t${r.league}\t${r.prematchLive}\t${r.startDate}\t${r.eventName}`
    );
    const requestTime = getRequestTime();
    const reason = getSelectedReason() || '________________';
    const done = doneTimeStr || '__:__';
    const note = `${requestTime} pls cancel (${reason})\n${done} done`;
    return tableLines.join('\n') + '\n\n' + note;
  }

  function updateAllPreview() {
    if (allRows.length === 0) return;
    document.getElementById('allPreview').textContent = buildAllText();
  }

  function copyAll() {
    const checked = getCheckedRows();
    if (checked.length === 0) {
      showToast('Please check at least one selection', '#e94560');
      return;
    }
    const reason = getSelectedReason();
    if (!reason) {
      showToast('Please select or enter a reason', '#f5a623');
      return;
    }
    copyToClipboard(buildAllText(), `Copied ${checked.length} selection(s)!`);
  }

  function copyToClipboard(text, msg) {
    navigator.clipboard.writeText(text).then(() => {
      showToast(msg || 'Copied!', '#4caf50');
    }).catch(() => {
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      showToast(msg || 'Copied!', '#4caf50');
    });
  }

  function clearAll() {
    document.getElementById('jsonInput').value = '';
    document.getElementById('resultSection').classList.remove('active');
    document.getElementById('dataBody').innerHTML = '';
    document.getElementById('allPreview').textContent = '';
    document.getElementById('requestHour').value = '';
    document.getElementById('requestMinuteInput').value = '';
    document.getElementById('reasonSelect').value = document.getElementById('reasonSelect').options[0].value;
    document.getElementById('customReason').style.display = 'none';
    document.getElementById('customReason').value = '';
    document.getElementById('doneTimeDisplay').textContent = '--:--';
    document.getElementById('checkedCount').textContent = '0 selected';
    document.getElementById('selectAll').checked = false;
    document.getElementById('selectAll').indeterminate = false;
    allRows = [];
    checkedSet = new Set();
    doneTimeStr = '';
  }

  function showToast(msg, color) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.style.background = color || '#4caf50';
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2000);
  }

  // Live preview updates
  document.getElementById('customReason').addEventListener('input', updateAllPreview);
  document.getElementById('reasonSelect').addEventListener('change', updateAllPreview);
</script>

</body>
</html>
